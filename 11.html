<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAMI X-PRO | الاحترافي</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #d4af37;
            --bg: #050505;
            --card: #121212;
            --text: #ffffff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; }
        
        /* مشغل الفيديو الاحترافي */
        .video-section { position: sticky; top: 0; z-index: 1000; background: #000; box-shadow: 0 4px 20px rgba(0,0,0,0.9); }
        .plyr--video { max-height: 60vh; }

        /* الأقسام */
        .tabs-container { display: flex; background: var(--card); padding: 5px; border-radius: 12px; margin: 15px; border: 1px solid #222; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; font-weight: bold; font-size: 14px; }
        .tab-btn.active { background: var(--primary); color: #000; }

        /* قائمة التصنيفات */
        .categories-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 0 15px 15px; scrollbar-width: none; }
        .categories-scroll::-webkit-scrollbar { display: none; }
        .cat-badge { padding: 8px 16px; background: #1a1a1a; border-radius: 20px; white-space: nowrap; font-size: 13px; border: 1px solid #333; cursor: pointer; }
        .cat-badge.active { border-color: var(--primary); color: var(--primary); background: rgba(212, 175, 55, 0.1); }

        /* شبكة المحتوى */
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; padding: 15px; }
        .media-card { background: var(--card); border-radius: 15px; padding: 8px; transition: 0.3s; border: 1px solid #222; cursor: pointer; position: relative; overflow: hidden; }
        .media-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .media-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 10px; margin-bottom: 8px; background: #222; }
        .media-card.live img { aspect-ratio: 1/1; object-fit: contain; }
        .media-card p { font-size: 11px; font-weight: 600; text-align: center; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        /* تحسينات البحث */
        .search-box { margin: 0 15px 15px; position: relative; }
        .search-box input { width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 12px 45px 12px 15px; border-radius: 12px; outline: none; transition: 0.3s; }
        .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; }

        /* شاشة التحميل */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 50px; height: 50px; border: 3px solid #1a1a1a; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p class="mt-4 font-bold text-yellow-500">DAMI X-PRO</p>
    </div>

    <div class="video-section">
        <video id="player" playsinline controls crossorigin></video>
    </div>

    <div class="tabs-container">
        <div onclick="switchMainType('get_live_streams', this)" class="tab-btn active"><i class="fas fa-tv ml-2"></i>مباشر</div>
        <div onclick="switchMainType('get_vod_streams', this)" class="tab-btn"><i class="fas fa-film ml-2"></i>أفلام</div>
        <div onclick="switchMainType('get_series', this)" class="tab-btn"><i class="fas fa-layer-group ml-2"></i>مسلسلات</div>
    </div>

    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="ابحث عن قناتك المفضلة...">
    </div>

    <div id="catList" class="categories-scroll"></div>

    <main id="mainContent" class="content-grid"></main>

    <div id="loadMore" class="p-6 text-center hidden">
        <button onclick="renderNextPage()" class="bg-zinc-800 px-8 py-3 rounded-xl font-bold border border-zinc-700">عرض المزيد</button>
    </div>

    <script>
        const CONFIG = {
            base: "http://ottpro.iptvpro2.com:8789",
            user: "Oujakr12",
            pass: "87593226",
            // بروكسي احترافي لحل مشكلة Chrome CORS و Mixed Content
            proxy: "https://api.allorigins.win/get?url="
        };

        let currentAction = 'get_live_streams';
        let fullData = [];
        let filteredData = [];
        let page = 1;
        const perPage = 40;

        const video = document.getElementById('player');
        const hls = new Hls();
        const player = new Plyr(video, { 
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
            tooltips: { controls: true, seek: true }
        });

        // دالة جلب البيانات مع التفاف حول قيود كروم
        async function smartFetch(action, params = "") {
            document.getElementById('loader').style.display = 'flex';
            const targetUrl = `${CONFIG.base}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=${action}${params}`;
            
            try {
                // محاولة الجلب عبر البروكسي لتجنب حظر كروم
                const response = await fetch(CONFIG.proxy + encodeURIComponent(targetUrl));
                if (!response.ok) throw new Error();
                const json = await response.json();
                const data = JSON.parse(json.contents);
                document.getElementById('loader').style.display = 'none';
                return data;
            } catch (err) {
                console.error("Fetch Error:", err);
                document.getElementById('loader').style.display = 'none';
                return [];
            }
        }

        async function switchMainType(action, btn) {
            currentAction = action;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            let catAction = 'get_live_categories';
            if(action === 'get_vod_streams') catAction = 'get_vod_categories';
            if(action === 'get_series') catAction = 'get_series_categories';

            const cats = await smartFetch(catAction);
            renderCats(cats);
            loadCategory('all');
        }

        function renderCats(cats) {
            const container = document.getElementById('catList');
            container.innerHTML = `<div class="cat-badge active" onclick="loadCategory('all', this)">الكل</div>`;
            cats.forEach(c => {
                container.innerHTML += `<div class="cat-badge" onclick="loadCategory('${c.category_id}', this)">${c.category_name}</div>`;
            });
        }

        async function loadCategory(id, el = null) {
            if(el) {
                document.querySelectorAll('.cat-badge').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
            const params = id === 'all' ? "" : `&category_id=${id}`;
            fullData = await smartFetch(currentAction, params);
            filteredData = [...fullData];
            page = 1;
            renderGrid();
        }

        function renderGrid(append = false) {
            const container = document.getElementById('mainContent');
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const items = filteredData.slice(start, end);

            const html = items.map(item => `
                <div class="media-card ${currentAction === 'get_live_streams' ? 'live' : ''}" 
                     onclick="playSource('${item.stream_id || item.series_id || item.vod_id}', '${item.container_extension || 'm3u8'}')">
                    <img src="${item.stream_icon || item.cover || 'https://via.placeholder.com/150'}" loading="lazy">
                    <p>${item.name}</p>
                </div>
            `).join('');

            if(append) container.innerHTML += html;
            else container.innerHTML = html;

            document.getElementById('loadMore').style.display = filteredData.length > end ? 'block' : 'none';
        }

        function renderNextPage() {
            page++;
            renderGrid(true);
        }

        function playSource(id, ext) {
            let type = 'live';
            if(currentAction === 'get_vod_streams') type = 'movie';
            if(currentAction === 'get_series') type = 'series';

            const format = (currentAction === 'get_live_streams') ? 'm3u8' : (ext || 'mp4');
            const streamUrl = `${CONFIG.base}/${type}/${CONFIG.user}/${CONFIG.pass}/${id}.${format}`;

            if (Hls.isSupported() && format === 'm3u8') {
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = streamUrl;
                video.play().catch(() => {
                    alert("تنبيه: كروم قد يمنع التشغيل. إذا لم يعمل، اضغط على أيقونة القفل بجانب الرابط وفعل خيار (Insecure Content / المحتوى غير الآمن)");
                });
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // بحث متطور
        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            filteredData = fullData.filter(i => i.name.toLowerCase().includes(term));
            page = 1;
            renderGrid();
        };

        window.onload = () => switchMainType('get_live_streams', document.querySelector('.tab-btn'));
    </script>
</body>
</html>
